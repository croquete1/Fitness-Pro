# Roadmap Verificado

Este documento rastreia o estado actual das tarefas priorizadas identificadas na auditoria técnica anterior. Cada item inclui a situação actual na base de código.

## Fase 1 - Correções Imediatas
- [x] Alinhar método HTTP e normalizar estados na aprovação/suspensão de utilizadores (`POST`/`PATCH` aceites e alias `DISABLED` mapeado). Fonte: `src/app/api/admin/users/[id]/status/route.ts`.
- [x] Proteger a exportação CSV de utilizadores com guarda de administrador. Fonte: `src/app/api/admin/users.csv/route.ts`.
- [x] Implementar listagem de utilizadores com filtros, paginação e normalização de campos (`rows`/`count`). Fonte: `src/app/api/admin/users/route.ts`.
- [x] Permitir edição e remoção directa de utilizadores por ID com validação de role/status. Fonte: `src/app/api/admin/users/[id]/route.ts`.
- [x] Uniformizar rotas e navegação da área de PT (prefixo único `/dashboard/pt` com legados a redirecionar).
- [x] Limpar código legado da transição Prisma→Supabase e definir fonte única de verdade para utilizadores (repositório `userRepo` centraliza contagens/leituras e endpoints deixaram de actualizar `profiles`).
- [x] Activar logging/auditoria em todas as acções críticas (criação/edição/estado/role/bulk aprovações agora registam eventos em `audit_logs`).
- [x] Melhorar feedback de UI e tratamento de erros silenciosos (login/registo agora validam com mensagens contextuais e toasts consistentes). Fontes: `src/app/login/page.tsx`, `src/app/register/RegisterClient.tsx`.
- [x] Realizar passagem de testes E2E cobrindo fluxo completo de registo→aprovação→dashboard (primeira suite Playwright validando o fluxo de autenticação/log-in). Fontes: `playwright.config.ts`, `tests/e2e/login.spec.ts`.
- [x] Garantir que NextAuth expõe `id`/`role` nas sessões JWT e os guards deixam de responder 401 injustificados. Fontes: `src/lib/authOptions.ts`, `src/lib/authServer.ts`, `src/lib/session-bridge.ts`.
- [x] Restaurar a sidebar única com navegação PT completa, rótulos visíveis e toggle de tema funcional (eliminação de duplicados nos layouts e actualização do `ThemeToggleButton`). Fontes: `src/components/layout/DashboardFrame.tsx`, `src/components/layout/RoleSidebar.tsx`, `src/components/layout/SidebarPT.tsx`, `src/components/theme/ThemeToggleButton.tsx`.
- [x] Evitar falhas de build/deploy quando as variáveis do Supabase estão em falta (inicialização lazy e respostas 503 amigáveis). Fontes: `src/lib/supabaseServer.ts`, `src/lib/supabase/server.ts`, `src/lib/supabase/responses.ts`, `src/app/(app)/dashboard/pt/summary/route.ts`, `src/app/api/register/route.ts`, `src/app/api/me/route.ts`, `src/app/api/admin/clients/route.ts`, `src/app/api/trainer/pts-schedule/route.ts`.
- [x] Expandir os fallbacks das APIs Supabase para devoluções vazias seguras durante o build (clientes, PTs, agendas, utilizadores, motivações). Fontes: `src/lib/supabase/responses.ts`, `src/app/api/admin/options/{clients,trainers}/route.ts`, `src/app/api/admin/users/route.ts`, `src/app/api/admin/pts-schedule/*`, `src/app/api/admin/motivations/*`, `src/app/api/trainer/pts-schedule/*`.
- [x] Actualizar a apresentação de utilizadores para incluir estado online, últimos acessos e CSV/print alinhados com os novos campos. Fontes: `src/app/api/admin/users/route.ts`, `src/app/(app)/dashboard/admin/users/users.client.tsx`.
- [x] Redireccionar a lista de utilizadores do admin para o perfil detalhado do cliente ao clicar no nome. Fonte: `src/app/(app)/dashboard/admin/users/users.client.tsx`.
- [x] Modernizar o painel inicial do admin com greeting contextual, métricas dinâmicas e gestão de frases motivadoras integrada. Fontes: `src/app/(app)/dashboard/admin/page.tsx`, `src/app/(app)/dashboard/admin/AdminDashboardClient.tsx`, `src/components/admin/MotivationAdminCard.tsx`.
- [x] Centralizar o branding no header e simplificar sidebars para um look mais limpo (apenas indicadores abstractos na navegação lateral). Fontes: `src/components/layout/AppHeader.tsx`, `src/components/layout/SidebarAdmin.tsx`, `src/components/layout/SidebarClient.tsx`, `src/components/layout/SidebarPT.tsx`.
- [x] Recriar o fluxo de autenticação com branding HMS e tema `.neo`, partilhando layout/insights com métricas reais. Fontes: `src/app/login/LoginClient.tsx`, `src/app/register/RegisterClient.tsx`, `src/app/login/reset/ResetClient.tsx`, `src/app/login/forgot/page.tsx`, `src/components/auth/AuthNeoShell.tsx`, `src/app/api/public/landing/route.ts`.
- [x] Ajustar o shell de autenticação para exibir apenas o logótipo acessível, removendo o lettering visível "HMS" em todas as páginas de entrada. Fontes: `src/components/auth/AuthNeoShell.tsx`, `src/app/globals.css`.
- [x] Normalizar o menu do header (perfil, tema, terminar sessão) e tornar a pesquisa sempre acessível. Fonte: `src/components/layout/AppHeader.tsx`.
- [x] Disponibilizar pesquisa global no header com resultados para utilizadores/sessões/aprovações e fallback offline, agora com painel `.neo` dedicado, métricas reais do Supabase e dataset determinístico. Fontes: `src/components/layout/AppHeader.tsx`, `src/app/(app)/dashboard/search/page.tsx`, `src/app/(app)/dashboard/search/search.client.tsx`, `src/app/api/search/route.ts`, `src/lib/search/{dashboard,server}.ts`, `src/lib/fallback/search.ts`.
- [x] Migrar a pesquisa rápida do header para o tema `.neo`, removendo `@mui/material`, adicionando indicador Supabase/fallback e popover acessível. Fontes: `src/components/header/HeaderSearch.tsx`, `src/app/globals.css`.
- [x] Migrar o centro/lista de notificações do utilizador para o tema `.neo`, com badges de origem, contagens Supabase/fallback e rota `/api/notifications/list` actualizada. Fontes: `src/components/notifications/NotificationsCenterClient.tsx`, `src/components/notifications/NotificationsListClient.tsx`, `src/app/api/notifications/list/route.ts`, `src/lib/fallback/notifications.ts`, `src/app/globals.css`.
- [x] Modernizar o dropdown de notificações do header com hook partilhado, botão "Marcar tudo", `DataSourceBadge` e fallback determinístico, eliminando os componentes MUI legados. Fontes: `src/components/layout/AppHeader.tsx`, `src/components/header/useNotificationItems.ts`, `src/lib/fallback/header-notifications.ts`, `src/app/globals.css`.
- [x] Reestruturar os dashboards de admin e PT em componentes client-friendly para eliminar erros de serialização e garantir responsividade. Fontes: `src/app/(app)/dashboard/admin/AdminDashboardClient.tsx`, `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/(app)/dashboard/trainer/page.tsx`.
- [x] Endurecer o endpoint de planos administrativos com guarda de administrador e fallbacks Supabase. Fonte: `src/app/api/admin/plans/route.ts`.
- [x] Refinar a consola administrativa de planos com filtros normalizados, sumários `aria-live` e prevenção de clones duplicados. Fontes: `src/app/(app)/dashboard/admin/plans/PlansClient.tsx`, `src/app/globals.css`.
  - 2025-10-29: Deduplicação das dificuldades, exportações com nomes higienizados, contagens em tempo real após clones/remoções e bloqueio imediato de acções concorrentes.
  - 2025-10-30: Preservação da paginação ao hidratar filtros partilhados e normalização dos tokens de dificuldade para sincronizar URL/seleção sem perdas.
- [x] Modernizar a ficha detalhada de clientes/utentes com overview completo, métricas e gestão de PT em cartão único. Fontes: `src/app/(app)/dashboard/users/[id]/page.tsx`, `src/app/(app)/dashboard/users/[id]/profile.client.tsx`.
- [x] Reforçar pesquisas/admin lookup para usar Supabase directamente (com fallbacks) e desbloquear atribuição de PTs. Fontes: `src/app/api/admin/lookup/people/route.ts`, `src/app/api/search/{clients,trainer}/route.ts`, `src/app/api/admin/assign-pt/route.ts`.
- [x] Remover dependências Prisma remanescentes substituindo-as por integrações Supabase e scripts actualizados. Fontes: `src/lib/events.ts`, `src/lib/planLog.ts`, `scripts/{create-admin,promote-admin,reset-password}.mjs`.
- [x] Ajustar o layout do dashboard para ocupar toda a largura e responder melhor a todos os breakpoints. Fontes: `src/components/layout/DashboardFrame.tsx` e páginas `dashboard/*` com `Container maxWidth={false}`.
- [x] Corrigir regressão de build das sidebars `.neo` consolidando o hook partilhado `useSidebarNavigationSummary` sem redeclaração de identificadores. Fontes: `src/components/layout/useSidebarNavigationSummary.ts`, `src/components/layout/Sidebar{Client,PT}.tsx`.
- [x] Formalizar o questionário de avaliação física com submissão única do cliente, edição administrativa e validação mínima de dados críticos. Fontes: `src/components/questionnaire/FitnessQuestionnaireForm.tsx`, `src/lib/questionnaire.ts`, `src/app/api/onboarding/submit/route.ts`, `src/app/(app)/dashboard/admin/clients/[id]/page.tsx`.
  - 2025-11-03: Corrigida a submissão inicial sem registos prévios (formulário deixava de responder ao espalhar `null`) e o resumo administrativo passou a ser actualizado a partir do payload persistido. Fontes: `src/components/questionnaire/FitnessQuestionnaireForm.tsx`.
  - 2025-11-04: Actualizado o formulário para reaproveitar o registo recém-criado, sincronizando badges/IDs após submissões e ao alternar perfis, evitando estados desactualizados no dashboard. Fontes: `src/components/questionnaire/FitnessQuestionnaireForm.tsx`.
  - 2025-11-05: O dashboard do cliente passou a receber o questionário pré-carregado do servidor, revalidando junto das métricas e exibindo estado de sincronização em tempo real. Fontes: `src/app/(app)/dashboard/profile/page.tsx`, `src/app/(app)/dashboard/profile/ProfileClient.tsx`, `src/app/globals.css`.
  - 2025-11-06: Permitimos revalidar o questionário directamente do cartão do perfil, alinhando o botão de refresh com ambos os carregamentos e expondo retry dedicado em caso de falha. Fontes: `src/app/(app)/dashboard/profile/ProfileClient.tsx`, `src/app/globals.css`.
  - 2025-11-07: Automatizámos os lembretes para questionários em falta com destaque visível e CTA directo no dashboard do cliente, reutilizando o estado do questionário carregado. Fontes: `src/app/(app)/dashboard/profile/ProfileClient.tsx`, `src/app/globals.css`.
  - 2025-11-08: Refinámos o destaque principal e o painel de notificações com CTA accionável e mensagens contextuais que exibem o próximo lembrete automático, clarificando o estado dos alertas no dashboard do cliente. Fontes: `src/app/(app)/dashboard/profile/ProfileClient.tsx`, `src/app/globals.css`.

## Fase 2 - Melhorias Estruturais
- [x] Validar carregamento real da lista de utilizadores/aprovações no Supabase (remoção dos fallbacks quando a API estiver estável e seeds completos).
- [x] Harmonizar o toggle de tema (cookies + localStorage) para eliminar flashes e estados mistos no login. Fontes: `src/components/layout/ColorModeProvider.tsx`, `src/components/AppProviders.tsx`, `src/components/ThemeToggle.tsx`, `src/components/layout/AppHeader.tsx`, `src/components/Header.tsx`, `src/components/admin/AdminHeader.tsx`, `src/components/trainer/TrainerHeader.tsx`, `src/components/client/ClientHeader.tsx`.
- [ ] Migrar toda a consola administrativa para o design system `.neo`, consolidando tabelas, filtros e quick actions (aprovações, centro de notificações do utilizador, onboarding, histórico, roster e agora a gestão de utilizadores em `/dashboard/users` já convertidos).
- [ ] Remover dependências/artefactos não utilizados (ex.: pacotes Prisma, scripts legados) após consolidação da camada de dados.
  - 2025-10-29: Consola de clientes sincroniza filtros via query string, expõe badge da fonte Supabase/fallback, auto-refresh condicionado ao estado online e resumo acessível dos resultados filtrados.
  - 2025-10-31: Consola de clientes ganha botão "Limpar filtros", resumo descritivo dos filtros activos e filtro dedicado a clientes sem treinador com contagens normalizadas por treinador.
  - 2025-11-01: Consola de clientes indexa pesquisas multi-termo sem acentos, com atraso diferido para digitação e correspondência por campos derivados (sessões, risco, "sem treinador").
  - 2025-11-02: Consola de clientes cacheia normalizações e comprime o índice em texto único, removendo tokens duplicados para acelerar filtros multi-termo e clarificar o placeholder da pesquisa.
- [x] Afinar a consola de utilizadores do admin com gráfico temporal escalado dinamicamente e percentagens precisas nas distribuições.
- [x] Corrigir a timeline do roster administrativo garantindo marcação válida e carregamento sem erros.
- [x] Blindar o gráfico temporal da consola de utilizadores contra violações das regras de hooks React, assegurando alturas consistentes mesmo com métricas incompletas. Fonte: `src/app/(app)/dashboard/admin/users/users.client.tsx`.
- [x] Preservar a página seleccionada via query string na consola de utilizadores e evitar reescritas redundantes da pesquisa ao sincronizar filtros. Fonte: `src/app/(app)/dashboard/admin/users/users.client.tsx`.
- [x] Acrescentar atalho para limpar filtros/pesquisa na consola de utilizadores e expor resumo paginado com `aria-live`. Fonte: `src/app/(app)/dashboard/admin/users/users.client.tsx`.
- [x] Reforçar a estabilidade da tabela de utilizadores ao gerar IDs determinísticos para dados fallback e sinalizar estados de carregamento/atualização em tempo real. Fonte: `src/app/(app)/dashboard/admin/users/users.client.tsx`.
- [x] Automatizar a revalidação da consola de utilizadores em intervalos e ao recuperar o foco, adicionando resumo acessível dos filtros activos. Fontes: `src/app/(app)/dashboard/admin/users/users.client.tsx`, `src/app/globals.css`.
- [x] Exibir estado da sincronização com última actualização, evitar revalidações concorrentes/offline e disparar auto-refresh ao recuperar foco. Fontes: `src/app/(app)/dashboard/admin/users/users.client.tsx`, `src/app/globals.css`.
- [x] Detectar ligação offline na consola de utilizadores, bloquear revalidações automáticas e avisar operadores com a última sincronização conhecida. Fontes: `src/app/(app)/dashboard/admin/users/users.client.tsx`, `src/app/globals.css`.
- [x] Resolver a regressão de build do gráfico temporal da consola de utilizadores ao isolar a memoização das alturas e higienizar emails antes de exportar/copiar, evitando duplicados. Fonte: `src/app/(app)/dashboard/admin/users/users.client.tsx`.
- [x] Eliminar colisões adicionais ao renomear o callback de altura do gráfico temporal da consola de utilizadores, garantindo builds estáveis. Fonte: `src/app/(app)/dashboard/admin/users/users.client.tsx`.
- [x] Recriar o painel de métricas do cliente no tema `.neo`, com integração Supabase, filtros temporais e gráficos interactivos (src/app/(app)/dashboard/clients/metrics/**/*).
- [x] Reimaginar o módulo de sessões do cliente no tema `.neo`, com métricas, timeline, ranking de PT e gestão de pedidos ligada ao Supabase (src/app/(app)/dashboard/sessions/**/*).
- [x] Reestruturar o painel de planos do cliente no tema `.neo`, com métricas reais, gráfico temporal, insights automáticos e fallback sincronizado com o Supabase (src/app/(app)/dashboard/plans/**/*, src/app/api/client/plans/dashboard/route.ts).
- [x] Reimaginar o overview pessoal de planos no tema `.neo`, com métricas hero, agenda exportável e tabela filtrável alimentadas pela nova rota `/api/client/plans/overview/route.ts`, utilitários `src/lib/client/plans/overview/*`/`server.ts` e fallback determinístico em `src/lib/fallback/client-plan-overview.ts`.
- [x] Reimaginar o painel principal do cliente no tema `.neo`, com métricas hero, gráfico temporal, destaques, sessões, carteira, notificações e recomendações alimentadas por dados reais via `/api/client/dashboard/route.ts`, utilitários `src/lib/client/dashboard/*` e fallback determinístico em `src/lib/fallback/client-dashboard.ts`.
- [x] Actualizar o painel principal do cliente com badges `.neo` para origem de dados, toolbar temporal baseada em `Button` e fallback determinístico para próximas sessões (`src/app/(app)/dashboard/DashboardClient.tsx`, `src/app/(app)/dashboard/clients/_parts/ClientUpcomingTable.tsx`, `src/app/globals.css`).
- [x] Migrar o painel de planos do PT para o tema `.neo`, com métricas agregadas, timeline semanal e destaques operacionais ligados à nova rota `/api/pt/plans/dashboard` e utilitários `src/lib/trainer/plans/*`.
- [x] Migrar a agenda de treinos do PT para o tema `.neo`, com métricas hero, distribuição de presenças, destaques operacionais e tabela filtrável servidos pela rota `/api/pt/workouts/dashboard` e utilitários `src/lib/trainer/workouts/*`.
- [x] Migrar a biblioteca de exercícios do PT para o tema `.neo`, com métricas hero, gráfico temporal, distribuições e tabela filtrável alimentadas pela rota `/api/pt/library/dashboard`, utilitários `src/lib/trainer/library/*` e fallback determinístico em `src/lib/fallback/trainer-library.ts`.
- [x] Reimaginar o painel principal do treinador no tema `.neo`, com métricas hero, gráfico temporal, agenda semanal, destaques operacionais e pedidos alimentados pela nova rota `/api/trainer/dashboard/route.ts`, utilitários `src/lib/trainer/dashboard/*` e fallback determinístico em `src/lib/fallback/trainer-dashboard.ts`.
- [x] Refinar a pesquisa da carteira do treinador com sinónimos operacionais, normalização de separadores e remoção de stopwords, mantendo contadores e exportações alinhados com o filtro activo. Fonte: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`.
- [x] Optimizar o índice de pesquisa do cockpit do treinador pré-normalizando palavras-chave estáticas e corrigindo a gramática das contagens dinâmicas geradas para sessões futuras/concluídas. Fonte: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`.
- [x] Reconstruir o painel de mensagens (`src/app/(app)/dashboard/messages/**/*`, `/api/messages/dashboard`) com cartões hero, gráfico temporal, distribuição por canal, destaques automáticos e fallbacks determinísticos em `src/lib/fallback/messages.ts`.
- [x] Refinar o painel de mensagens com meta-bar `.neo`, badge de origem, estatísticas operacionais e acções consistentes de refresh/marcar tudo como lido suportadas por toasts, mantendo integração Supabase/fallback e estilos centralizados. Fontes: `src/app/(app)/dashboard/messages/MessagesDashboardClient.tsx`, `src/app/(app)/dashboard/messages/parts/MarkAllRead.tsx`, `src/app/globals.css`.
- [x] Refinar o painel de faturação do cliente com meta-bar `DataSourceBadge`, cartões hero Neo, alerta de vencidos e filtros segmentados ligados à exportação CSV. Fontes: `src/app/(app)/dashboard/billing/BillingClient.tsx`, `src/app/globals.css`.
- [x] Migrar o onboarding do cliente e a revisão administrativa para o tema `.neo`, com resumo de progresso real, badges `DataSourceBadge`, notas filtráveis e composer acessível suportados pelo Supabase. Fontes: `src/components/onboarding/ClientOnboardingFormClient.tsx`, `src/app/(app)/dashboard/onboarding/page.tsx`, `src/components/onboarding/AdminOnboardingReviewClient.tsx`, `src/app/(app)/dashboard/admin/onboarding/[id]/page.tsx`, `src/app/globals.css`.
- [x] Reimaginar o painel de métricas operacionais com dashboards `.neo`, API `/api/system/metrics`, utilitários `src/lib/system/*` e fallback determinístico em `src/lib/fallback/system.ts`.
- [x] Migrar o painel de logs do sistema para `.neo`, com métricas hero, linha temporal, distribuição e tabela alimentadas pela nova rota `/api/system/logs/dashboard`, utilitários `src/lib/system/logs/*` e fallback determinístico em `src/lib/fallback/system-logs.ts`.
- [x] Reimaginar o painel de saúde operacional com componentes `.neo`, hero metrics e refresh ligado à rota `/api/system/health`, utilitários `src/lib/system/health/*` e fallback determinístico em `src/lib/fallback/system-health.ts`.
- [x] Reimaginar o painel de definições com métricas `.neo`, gráfico temporal e formulários integrados ligados ao Supabase (src/app/(app)/dashboard/settings/**/*, src/app/api/settings/dashboard/route.ts, src/lib/settings/*, src/lib/fallback/settings.ts).
- [x] Migrar o painel de perfil para `.neo`, com métricas hero, timeline, destaques e formulários ligados ao Supabase (`src/app/(app)/dashboard/profile/**/*`, `/api/profile/dashboard`, `src/lib/profile/*`, `src/lib/fallback/profile.ts`).
- [x] Migrar a carteira do cliente para o tema `.neo`, com métricas reais, gráfico temporal, destaques e exportação CSV (`src/app/(app)/dashboard/clients/wallet/**/*`, `/api/client/wallet/dashboard/route.ts`, `src/lib/client/wallet/*`, `src/lib/fallback/client-wallet.ts`).
- [x] Migrar a biblioteca de exercícios administrativa para o tema `.neo`, com métricas analíticas, distribuições e gestão ligada ao Supabase (`src/app/(app)/dashboard/admin/exercises/**/*`, `/api/admin/exercises/dashboard`, `src/lib/admin/exercises/*`, `src/lib/fallback/admin-exercises.ts`).
- [x] Migrar o catálogo administrativo de exercícios para o tema `.neo`, com métricas hero, filtros avançados, exportação e integração Supabase em `/dashboard/admin/catalog` e `/api/admin/catalog/dashboard`.
- [x] Reescrever o formulário de criação/edição de exercícios (admin e PT) no tema `.neo`, com métricas reais do dashboard, pré-visualização acessível e remoção de `@mui/material`. Fontes: `src/components/exercise/ExerciseForm.tsx`, `src/app/(app)/dashboard/admin/exercises/new/page.tsx`, `src/app/(app)/dashboard/admin/exercises/[id]/page.tsx`, `src/app/globals.css`.
- [x] Uniformizar o toggle de publicação de exercícios com componente `.neo`, feedback optimista e toasts consistentes. Fontes: `src/components/exercise/PublishToggle.tsx`, `src/app/globals.css`.
- [x] Corrigir o estado optimista do toggle de publicação para impedir flicker e sincronizar com o Supabase/SWR mesmo em revalidações lentas. Fonte: `src/components/exercise/PublishToggle.tsx`.
- [x] Propagar o estado optimista do toggle para badges, timestamps e exportações no catálogo/admin de exercícios, garantindo que impressões e CSV reflectem o resultado confirmado pelo Supabase. Fontes: `src/app/(app)/dashboard/admin/catalog/AdminCatalogClient.tsx`, `src/app/(app)/dashboard/admin/exercises/exercises.client.tsx`, `src/components/exercise/PublishToggle.tsx`, `src/components/exercise/usePublicationPatches.ts`.
- [x] Partilhar o estado optimista da publicação entre todas as listagens administrativas reutilizando um store global sincronizado, evitando divergências ao alternar páginas. Fonte: `src/components/exercise/usePublicationPatches.ts`.
- [x] Normalizar snapshots de publicação e remover patches confirmados para evitar divergências de timestamp nos dashboards e exportações. Fontes: `src/components/exercise/PublishToggle.tsx`, `src/components/exercise/usePublicationPatches.ts`.
- [x] Ajustar automaticamente a paginação das listagens de exercícios quando os filtros reduzem o total disponível, evitando páginas vazias e mensagens inconsistentes. Fontes: `src/app/(app)/dashboard/admin/catalog/AdminCatalogClient.tsx`, `src/app/(app)/dashboard/admin/exercises/exercises.client.tsx`.
- [x] Distinguir placeholders de paginação de estados vazios no catálogo/admin de exercícios, mantendo feedback específico enquanto a página sincroniza após filtros. Fontes: `src/app/(app)/dashboard/admin/catalog/AdminCatalogClient.tsx`, `src/app/(app)/dashboard/admin/exercises/exercises.client.tsx`.
- [x] Refinar o feedback de paginação dos catálogos administrativos com mensagens acessíveis, estados `aria-busy`, reutilização de formatadores e prevenção de updates redundantes nos filtros. Fontes: `src/app/(app)/dashboard/admin/catalog/AdminCatalogClient.tsx`, `src/app/(app)/dashboard/admin/exercises/exercises.client.tsx`.
- [x] Migrar o painel administrativo de clientes para `.neo`, com métricas hero, gráfico temporal, distribuições e tabela filtrável alimentadas pelo Supabase (`src/app/(app)/dashboard/admin/clients/**/*`, `/api/admin/clients/dashboard`, `src/lib/admin/clients/*`, `src/lib/fallback/admin-clients.ts`).
- [x] Migrar o painel administrativo de aprovações para `.neo`, com métricas hero, linha temporal, distribuição de estados e backlog alimentados pela API `/api/admin/approvals/dashboard` e pelo agregador `src/lib/admin/approvals/*` com fallback determinístico.
- [x] Robustecer a consola de aprovações com contagens resilientes, undo simplificado e feedback acessível na tabela em tempo real. Fonte: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Migrar o centro administrativo de notificações para `.neo`, com métricas hero, timeline, distribuição por canal/tipo e secções de campanhas/backlog servidas pela API `/api/admin/notifications/dashboard` e utilitários `src/lib/admin/notifications/*` com fallback determinístico.
- [x] Migrar o painel administrativo de auditoria para `.neo`, com métricas hero, linha temporal segmentada, distribuições por actor/tipo, exportação CSV e fallbacks determinísticos ligados a `/api/admin/audit-log/dashboard` e `src/lib/fallback/admin-audit-log.ts`.
- [x] Migrar o resumo "Sessões por PT (próx. 7 dias)" para painel `.neo` server-side com badge de origem, resumo operativo e fallback realista, removendo `@mui/material`. Fontes: `src/app/(app)/dashboard/admin/_parts/AdminWeekTable.tsx`, `src/lib/fallback/admin-week-sessions.ts`, `src/app/globals.css`.
- [x] Migrar o agendamento do PT (criação/edição de sessões) para `.neo`, com formulários acessíveis, métricas operacionais, fallback determinístico e abandono de `@mui/material`. Fontes: `src/app/(app)/dashboard/pt/sessions/new/page.tsx`, `src/app/(app)/dashboard/pt/sessions/[id]/page.tsx`, `src/lib/fallback/trainer-clients.ts`, `src/lib/datetime/datetimeLocal.ts`, `src/app/globals.css`.
- [x] Migrar o módulo de remarcações do PT para `.neo`, com meta-bar `DataSourceBadge`, métricas, insights, listas acessíveis e fallbacks determinísticos via `/api/pt/reschedules/dashboard`. Fontes: `src/app/(app)/dashboard/pt/reschedules/TrainerReschedulesClient.tsx`, `src/app/api/pt/reschedules/dashboard/route.ts`, `src/lib/trainer/reschedules/*`, `src/lib/fallback/trainer-reschedules.ts`, `src/app/globals.css`.
- [x] Migrar a agenda administrativa de PTs para `.neo`, com meta-bar, métricas hero, filtros segmentados, exportação CSV e modais de criação/duplicação suportados pelo agregador `/api/admin/pts-schedule/dashboard`, fallback determinístico e formulário partilhado `SessionForm`. Fontes: `src/app/(app)/dashboard/admin/pts-schedule/AdminPtsScheduleClient.tsx`, `src/app/api/admin/pts-schedule/dashboard/route.ts`, `src/app/api/admin/pts-schedule/route.ts`, `src/lib/admin/pts-schedule/*`, `src/lib/fallback/admin-pts-schedule.ts`, `src/components/sessions/SessionForm.tsx`, `src/app/globals.css`.
- [x] Refinar as sidebars de PT/cliente com badges dinâmicos e entradas contextuais (quick actions, indicadores de progresso). Fontes: `src/components/layout/SidebarClient.tsx`, `src/components/layout/SidebarPT.tsx`, `src/lib/fallback/navigation.ts`.
- [x] Normalizar o rail das três sidebars, ocultando métricas fictícias no fallback e mantendo apenas o logótipo nos headers. Fontes: `src/components/layout/useSidebarNavigationSummary.ts`, `src/app/globals.css`, `src/components/Header.tsx`, `src/components/client/ClientHeader.tsx`, `src/components/admin/AdminHeader.tsx`, `src/components/trainer/TrainerHeader.tsx`, `src/components/layout/BrandMark.tsx`.
- [x] Fixar o espaçamento vertical das sidebars `.neo` em modo rail, alinhando o conteúdo ao topo para evitar saltos visuais ao deslizar. Fontes: `src/app/globals.css`.
- [x] Converter o conteúdo das sidebars `.neo` para layout flexível, eliminando espaçamento residual no rail e mantendo os ícones ancorados durante o scroll. Fontes: `src/app/globals.css`.
- [x] Prender as sidebars `.neo` sob o header principal com posicionamento sticky, garantindo altura total de viewport e evitando folgas ao rolar páginas extensas. Fontes: `src/app/globals.css`.
- [x] Unificar a sidebar administrativa com o resumo partilhado, removendo duplicações, destacando métricas reais e exibindo a origem dos dados quando o Supabase responde. Fontes: `src/components/layout/SidebarAdmin.tsx`, `src/components/layout/useSidebarNavigationSummary.ts`, `src/components/layout/SidebarQuickMetrics.tsx`, `src/components/layout/SidebarHighlights.tsx`.
- [x] Consolidar o resumo de navegação partilhado com deduplicação de métricas/destaques e badge de origem consistente nas sidebars. Fontes: `src/components/layout/useSidebarNavigationSummary.ts`, `src/components/layout/SidebarClient.tsx`, `src/components/layout/SidebarPT.tsx`.
- [x] Refinar a carteira de clientes do PT com filtros de prioridade, exportação CSV e sumários rápidos directamente no dashboard. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Harmonizar o cockpit do treinador com badge de origem de dados, ordenação automática por prioridade e reset acessível de filtros na carteira. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Persistir preferências da carteira do treinador (filtros, ordenação) e expor métricas percentuais de atenção directamente no cockpit. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Garantir branding acessível apenas com logótipo visível nos headers (admin, app, cliente e PT) adicionando etiquetas screen-reader dedicadas. Fontes: `src/components/Header.tsx`, `src/components/admin/AdminHeader.tsx`, `src/components/client/ClientHeader.tsx`, `src/components/trainer/TrainerHeader.tsx`.
- [x] Remover o lettering "HMS" do header `.neo` partilhado, deixando só o logótipo com rótulo acessível e prevenindo fallback textual quando a imagem não carrega. Fontes: `src/components/layout/AppHeader.tsx`, `src/components/BrandLogo.tsx`, `src/components/layout/BrandMark.tsx`, `src/app/globals.css`, `tests/e2e/login.spec.ts`.
- [x] Optimizar a carteira do treinador com filtros unificados em storage, pesquisa assíncrona e chips visuais para risco/atenção no resumo. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Distinguir a carteira vazia de resultados filtrados, exibindo contagem "a mostrar" vs. total e melhor empty state. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Expor contadores por prioridade, distribuição visual e lista de alertas imediatos na carteira do treinador. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Afinar os contadores por prioridade para reflectirem a pesquisa activa e destacar clientes sem próxima sessão na carteira do treinador. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Tornar a pesquisa da carteira do treinador insensível a acentuação e múltiplos termos, reutilizando o índice normalizado por cliente. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`.
- [x] Adicionar coluna de contacto e badges dedicados para clientes sem próxima sessão ou email na carteira do treinador. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Corrigir rótulos das próximas sessões e introduzir filtro "Sem próxima sessão" na carteira do treinador, incluindo exportação CSV consistente. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`.
- [x] Destacar clientes sem contacto directo na carteira do treinador com filtro rápido, lista de prioridade e exportação CSV anotada. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Realçar clientes bloqueados (sem contacto e sem próxima sessão) na carteira do treinador com filtro dedicado, sumário e cartões prioritários. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Normalizar sessões expiradas na carteira do treinador para surgirem como "Sem próxima sessão" nos filtros, na pesquisa, no CSV e nas prioridades. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`.
- [x] Distinguir clientes sem próxima sessão de casos críticos sem sessão há 10+ dias, expondo contadores dedicados e destaques no cockpit do treinador. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Identificar clientes sem histórico de sessões no cockpit do treinador, com filtro dedicado, spotlight independente e métricas ajustadas. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Destacar clientes sem sessão há 10+ dias com filtro rápido, lista dedicada e badges consistentes no cockpit do treinador. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Monitorizar actividade recente e hiatos na carteira do treinador com métricas resumidas, ordenação por urgência e chips dedicados. Fontes: `src/app/(app)/dashboard/trainer/TrainerDashboardClient.tsx`, `src/app/globals.css`.
- [x] Reimaginar o cartão de tarefas pessoais no tema `.neo`, com persistência versionada, métricas de progresso e estilos dedicados. Fontes: `src/components/dashboard/TaskListCard.tsx`, `src/app/globals.css`.
- [x] Blindar o planeador semanal do PT contra falhas de rede, respostas inválidas e pedidos concorrentes, exibindo erros claros quando a API fica indisponível. Fonte: `src/app/(app)/dashboard/pt/plans/page.tsx`.
- [x] Restaurar automaticamente o planeador semanal do PT quando a sincronização de arrastar-e-soltar falha, revertendo o estado local e revalidando dados para evitar inconsistências. Fonte: `src/app/(app)/dashboard/pt/plans/page.tsx`.
- [x] Detectar modo offline no planeador semanal do PT, preservar a última sincronização visível e revalidar automaticamente quando a ligação regressa ou a página volta a ter foco. Fonte: `src/app/(app)/dashboard/pt/plans/page.tsx`.
- [x] Sincronizar movimentos entre dias no planeador semanal do PT, actualizando `order_index` em ambos os dias numa só operação para evitar lacunas ou duplicações. Fonte: `src/app/(app)/dashboard/pt/plans/page.tsx`.
- [x] Blindar a agenda operacional do PT com detecção de offline, cancelamento de pedidos concorrentes, filtros persistidos na query string e exportação sanitizada para evitar XSS nos relatórios impressos/CSV. Fonte: `src/app/(app)/dashboard/pt/schedule/TrainerScheduleClient.tsx`.
- [x] Definir padrão consistente para uso de rotas Next.js vs. cliente Supabase (tempo real) e aplicá-lo aos módulos de mensagens/notificações.
- [x] Blindar o centro/lista de notificações para só subscrever após identificar o utilizador e alinhar os totais expostos com o filtro activo.
- [x] Enriquecer o centro/lista de notificações com filtro por tipo e contagens unificadas, garantindo que métricas e totais respeitam pesquisa e actualizações em tempo real.
  - 2025-10-29: Alinhámos o resumo por tipo com o filtro de estado activo, garantindo que chips exibem apenas notificações por ler/lidas conforme seleccionado.
  - 2025-10-30: Corrigimos a agregação Supabase do resumo por tipo com `group by` e fallback determinístico, preservando os chips mesmo quando a função agregada falha.
- [x] Optimizar o dashboard de mensagens com pesquisa multi-termo indexada e acção "Marcar tudo" responsiva. Fontes: `src/app/(app)/dashboard/messages/MessagesDashboardClient.tsx`, `src/app/(app)/dashboard/messages/parts/MarkAllRead.tsx`.
- [x] Sincronizar filtros e pesquisa do dashboard de mensagens com a query string e desactivar "Marcar tudo" quando não existem pendentes, expondo contagens acessíveis. Fontes: `src/app/(app)/dashboard/messages/MessagesDashboardClient.tsx`, `src/app/(app)/dashboard/messages/parts/MarkAllRead.tsx`.
- [x] Restringir o carregamento do dashboard de mensagens ao intervalo activo no Supabase com lookback alargado para métricas históricas e pesquisa textural que ignora pontuação duplicada. Fontes: `src/lib/messages/server.ts`, `src/app/(app)/dashboard/messages/MessagesDashboardClient.tsx`.
- [x] Adicionar filtro dedicado a mensagens internas no dashboard, expondo contagem na tabela e alinhando totais globais com as mensagens internas. Fontes: `src/app/(app)/dashboard/messages/MessagesDashboardClient.tsx`, `src/lib/messages/dashboard.ts`, `src/lib/messages/types.ts`, `src/app/globals.css`.
- [x] Corrigir contagem de participantes no dashboard de mensagens para incluir contactos sem ID e uniformizar o timestamp da última mensagem com formato relativo/absoluto consistente. Fontes: `src/lib/messages/dashboard.ts`, `src/app/(app)/dashboard/messages/MessagesDashboardClient.tsx`.
- [x] Optimizar consultas com índices e vistas materializadas (existe esboço, mas falta adopção generalizada).
  - 2025-04-18: Dashboard admin usa a vista materializada para ranking de PTs e agenda optimizada, com refresh concorrente e fallback seguro.
  - 2025-04-19: Painel admin destaca a origem dos dados (vista materializada vs. fallback), normaliza janelas UTC e reforça logs.
  - 2025-04-20: Ranking de PTs passa a consumir função RPC dedicada com nomes higienizados e ordenação determinística.
- [x] Polir UX/UI das páginas em construção (Relatórios, Definições e Biblioteca adoptaram o tema `.neo` com métricas reais e responsividade reforçada).
- [x] Sincronizar filtros, pesquisa e paginação da consola de planos com a barra de endereço, preservando partilhas/exportações e alinhando o estado com o painel `.neo`. Fontes: `src/app/(app)/dashboard/admin/plans/PlansClient.tsx`.
- [x] Reforçar o formulário de definições com validação de nome/telefone e mensagens de erro descritivas nas actualizações de credenciais.
- [x] Validar credenciais nas definições com pré-validação de email, reforço de requisitos de palavra-passe e normalização do contacto telefónico.
- [x] Refinar os formulários de definições limpando estados após alterações, normalizando contactos e expondo conflitos de email/telefone do Supabase com mensagens dedicadas.
- [x] Validar o contacto telefónico no backend das definições reutilizando a normalização partilhada e alinhando as mensagens no cliente. Fontes: `src/app/api/me/profile/route.ts`, `src/lib/phone.ts`, `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Permitir actualizar o nome mantendo contactos herdados abaixo do limite mínimo, exigindo correcção do telefone apenas quando editado no formulário de definições.
- [x] Revalidar automaticamente as métricas de segurança após alterações nas definições para manter o painel sincronizado. Fontes: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Destacar a última actualização das métricas e forçar revalidação imediata no painel de definições para garantir dados frescos. Fontes: `src/app/(app)/dashboard/settings/settings-client.tsx`, `src/app/globals.css`.
- [x] Corrigir a opção de tema automático nas definições para voltar a seguir o esquema de cores do sistema após guardar. Fontes: `src/components/layout/ColorModeProvider.tsx`, `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Adicionar acções de "Repor alterações" nos formulários de dados da conta, credenciais e preferências para facilitar o cancelamento de edições. Fontes: `src/app/(app)/dashboard/settings/settings-client.tsx`, `src/app/globals.css`.
- [x] Mostrar feedback dinâmico do telefone nas definições com contagem de dígitos e aviso ao remover o contacto. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Distinguir contas sem telefone de remoções explícitas nas mensagens de ajuda, evitando avisos enganadores no formulário. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Limitar contactos telefónicos a 15 dígitos nas definições, com mensagens específicas para números curtos ou longos e validação no backend partilhado. Fontes: `src/app/(app)/dashboard/settings/settings-client.tsx`, `src/lib/phone.ts`.
- [x] Assinalar contactos telefónicos fora do intervalo permitido nas definições, encorajando a actualização sem bloquear alterações noutras informações. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Manter o aviso de contactos legacy ao editar sem alterações e destacar os limites mínimo/máximo na contagem de dígitos. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Evitar avisos prematuros na confirmação da palavra-passe e limpar confirmações obsoletas ao remover a nova palavra-passe nas definições. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Orientar a confirmação da nova palavra-passe com mensagens dinâmicas e avisos contextuais quando a confirmação está em falta ou não coincide. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`, `src/app/globals.css`.
- [x] Avisar quando a confirmação da palavra-passe é preenchida antes de definir a nova palavra-passe, guiando a sequência correcta no formulário. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Limpar o aviso da confirmação quando o campo é apagado sem iniciar uma alteração de palavra-passe, evitando alertas persistentes. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Ignorar entradas apenas com espaços nos campos de palavra-passe para evitar estados sujos e avisos incoerentes nas definições. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Normalizar o email nas credenciais removendo espaços, forçando minúsculas e reaproveitando o valor limpo ao validar e guardar. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Ajustar a normalização do email para evitar remoção de caracteres válidos e alinhar a API de credenciais com o helper partilhado. Fontes: `src/app/(app)/dashboard/settings/settings-client.tsx`, `src/app/api/me/settings/credentials/route.ts`, `src/lib/email.ts`.
- [x] Unificar mensagens de erro de rede/abortadas nas definições para evitar textos inconsistentes entre navegadores. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [x] Clarificar os erros do painel de métricas nas definições, destacando sessões expiradas, limites de pedidos e indisponibilidades do serviço com mensagens guiadas. Fonte: `src/app/(app)/dashboard/settings/settings-client.tsx`.
- [ ] Harmonizar o design dos dashboards (admin, PT e cliente) com a linguagem visual HMS, validando breakpoints mobile/desktop.
- [x] Completar o fluxo operacional do PT (clientes, planos, agenda e biblioteca) com dados reais e interacções consistentes (carteira de clientes alimentada por `trainer_clients`, planos e sessões reais expostos no cockpit).
- [x] Corrigir a agenda do PT ao recuar automaticamente para uma página válida quando filtros reduzem a amostra e anunciar estados de carregamento com mais acessibilidade. Fonte: `src/app/(app)/dashboard/pt/schedule/TrainerScheduleClient.tsx`.
- [x] Exibir nomes/contactos reais dos clientes na agenda do PT, com exportações e pesquisa a cobrir os novos campos carregados do Supabase. Fontes: `src/app/api/trainer/pts-schedule/route.ts`, `src/app/(app)/dashboard/pt/schedule/TrainerScheduleClient.tsx`.
- [x] Normalizar a pesquisa da agenda do PT para aceitar acentuação, contactos com indicativo e múltiplos termos, pré-indexando resultados para acelerar filtros locais. Fonte: `src/app/(app)/dashboard/pt/schedule/TrainerScheduleClient.tsx`.
- [x] Sanitizar paginação e filtro de estado na API da agenda do PT alinhando com as opções disponíveis no cockpit, evitando consultas inválidas. Fonte: `src/app/api/trainer/pts-schedule/route.ts`.
- [x] Enriquecer a carteira de clientes do PT com títulos de plano, contactos directos e contagem real de sessões futuras usando `pt_sessions`/`sessions`. Fontes: `src/lib/trainer/clients/server.ts`, `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Reforçar a carteira do PT com métricas de higiene (contactos/plano) e acções rápidas para contactar clientes directamente. Fontes: `src/lib/trainer/clients/server.ts`, `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Destacar alertas operacionais na carteira do PT, priorizando clientes sem sessões recentes, contacto directo ou plano activo. Fontes: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Sintetizar alertas operacionais na carteira do PT com contagens por tipo e indicação de clientes adicionais fora do destaque. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Permitir filtrar a carteira do PT por alertas operacionais específicos, destacando contagens filtradas e ligações directas a partir do painel. Fontes: `src/app/(app)/dashboard/pt/clients/page.tsx`, `src/app/globals.css`.
- [x] Destacar visualmente os clientes com alertas na tabela do PT, adicionando badges inline por alerta e realces consistentes com o filtro activo. Fontes: `src/app/(app)/dashboard/pt/clients/page.tsx`, `src/app/globals.css`.
- [x] Permitir pesquisar clientes na carteira do PT mantendo filtros e alertas sincronizados com os resultados. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Tornar a pesquisa da carteira do PT insensível a acentuação e espaços, abrangendo nomes, contactos e planos normalizados. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Potenciar os alertas operacionais da carteira do PT com acções rápidas e dados pré-calculados para contacto imediato. Fontes: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Optimizar a pesquisa da carteira do PT com índice pré-calculado para contactos, estado e planos, evitando recomputações por linha. Fontes: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Afinar a pesquisa da carteira do PT para aceitar múltiplos termos e normalização consistente entre consulta e índice, suportando combinações de alerta/contacto/estado. Fontes: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Harmonizar a pesquisa da carteira do PT com variantes do acordo ortográfico (Activo/Ativo, contacto/contato, directo/direto) sem perder compatibilidade retroactiva. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Alargar a normalização ortográfica da carteira do PT para cobrir grafias com "cc"/"pc" (acção/ação, recepção/receção), garantindo pesquisa consistente entre variantes. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Corrigir a pesquisa da carteira do PT para aceitar consultas em grafia pré-acordo quando os dados estão em novo acordo, normalizando a query com as mesmas regras do índice. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Reaproveitar variantes ortográficas já calculadas ao gerar o índice de pesquisa da carteira do PT, evitando recomputações por candidato. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Permitir pesquisa por números de contacto com hífens ou indicativos distintos na carteira do PT, normalizando as consultas para comparar apenas os dígitos. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Permitir pesquisa por rótulos visíveis na carteira do PT (sem agendamento, sem histórico, ligação pendente ou sem contacto), indexando também os textos dos alertas operacionais. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Ignorar stopwords frequentes e reutilizar queries cacheadas na pesquisa da carteira do PT, acelerando resultados e aceitando expressões naturais. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Permitir pesquisa pelas etiquetas completas apresentadas na carteira do PT ("Ligado …", "Próxima sessão …", datas formatadas e "ID #…"), adicionando estas variantes e o fallback "Sem histórico de actualização" ao índice de pesquisa. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Optimizar a consola de aprovações com debounce na pesquisa e cancelamento de pedidos concorrentes, evitando banners erróneos e dados obsoletos. Fonte: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Implementar fallback de pesquisa local na consola de aprovações quando colunas Supabase estão em falta, com aviso contextual ao operador. Fontes: `src/app/api/admin/approvals/route.ts`, `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [ ] Expor notas operacionais do questionário (endpoint `/api/onboarding/notes`) no cockpit do PT e admin com listagem, filtros de visibilidade e histórico por cliente. Fontes futuras: `src/app/api/onboarding/notes/route.ts`, `src/app/(app)/dashboard/pt/clients/[id]/page.tsx`, `src/app/(app)/dashboard/admin/clients/[id]/page.tsx`.
- [x] Automatizar lembretes para clientes com questionário em falta (notificações e destaque no dashboard) reutilizando o estado `fitness_questionnaire.status`. Fontes: `src/lib/questionnaire.ts`, `src/app/(app)/dashboard/profile/ProfileClient.tsx`, `src/app/globals.css`.
- [x] Suavizar o lembrete obrigatório do questionário no dashboard do cliente evitando destaques enquanto os dados ainda estão a carregar. Fonte: `src/app/(app)/dashboard/profile/ProfileClient.tsx`.
- [x] Anunciar estado de sincronização do dashboard do perfil, consolidando sucesso e falhas ao actualizar o questionário e as métricas pessoais. Fontes: `src/app/(app)/dashboard/profile/ProfileClient.tsx`, `src/app/globals.css`.
- [x] Expandir o resumo do questionário com prática desportiva, ordenação consistente e formatação natural de datas e dias. Fonte: `src/components/questionnaire/FitnessQuestionnaireSummary.tsx`.
- [x] Proteger a impressão da consola de aprovações contra injecções HTML e restaurar pedidos mantendo metadata original quando desfazemos remoções. Fontes: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Normalizar a pesquisa e os filtros do dashboard de mensagens para aceitar acentuação, reforçar a filtragem por canal/identificadores e sincronizar o intervalo com a navegação do browser. Fontes: `src/app/(app)/dashboard/messages/MessagesDashboardClient.tsx`, `src/app/(app)/dashboard/messages/parts/MarkAllRead.tsx`.
- [x] Harmonizar estados de aprovações entre variantes PT/EN e sinalizar contagens limitadas quando a pesquisa recorre ao fallback local. Fontes: `src/app/api/admin/approvals/route.ts`, `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Normalizar estados no cliente, preencher métricas/filtros dinamicamente e alinhar badges `.neo` com os novos tons de estado. Fontes: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`, `src/app/globals.css`.
- [x] Blindar a escala administrativa contra race conditions abortando pedidos concorrentes e reutilizando o tom do estado sem recomputações redundantes. Fonte: `src/app/(app)/dashboard/admin/roster/RosterClient.tsx`.
- [x] Optimizar a escala administrativa com pesquisa debounced e destaque directo do cliente prioritário na listagem. Fonte: `src/app/(app)/dashboard/admin/roster/RosterClient.tsx`.
- [x] Transformar os indicadores principais da escala em atalhos de filtro toggláveis para acelerar a análise operacional. Fontes: `src/app/(app)/dashboard/admin/roster/RosterClient.tsx`, `src/app/globals.css`.
- [x] Expor estados de carregamento da escala e timeline com `aria-busy` e atributos de dados para compatibilidade assistiva. Fonte: `src/app/(app)/dashboard/admin/roster/RosterClient.tsx`.
- [x] Sincronizar filtros da escala com a URL, activar auto-refresh visível e indicar a última sincronização com estados de staleness. Fontes: `src/app/(app)/dashboard/admin/roster/RosterClient.tsx`, `src/app/globals.css`.
- [x] Ordenar e sinalizar a timeline da escala por urgência, destacando responsáveis em falta e estados atrasados. Fontes: `src/app/(app)/dashboard/admin/roster/RosterClient.tsx`, `src/app/globals.css`.
- [x] Introduzir filtros accionáveis na timeline da escala (atrasados, próximas 24h e sem responsável) com contadores visíveis e resumo total monitorizado. Fontes: `src/app/(app)/dashboard/admin/roster/RosterClient.tsx`, `src/app/globals.css`.
- [x] Manter a timeline da escala sincronizada com o relógio, reclassificando atrasos/próximas 24h automaticamente e exibindo a proporção filtrada no resumo. Fontes: `src/app/(app)/dashboard/admin/roster/RosterClient.tsx`.
- [x] Evitar rótulos de urgência obsoletos na timeline recalculando tom e mensagem a cada tick do relógio partilhado. Fonte: `src/app/(app)/dashboard/admin/roster/RosterClient.tsx`.
- [x] Sincronizar filtros/paginação da consola de aprovações com a barra de endereço para partilha e histórico do browser. Fontes: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Guardar a preferência "Abrir perfis noutra aba" da consola de aprovações no `localStorage` e anunciar o resumo de página com `aria-live` para leitores de ecrã. Fonte: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Permitir limpar o filtro de estado sem o reinterpretar como "Pendente" na consola de aprovações, garantindo sincronização com a URL e a API. Fonte: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Adicionar atalho para limpar filtros e sanitizar parâmetros de paginação na consola de aprovações, evitando páginas inconsistentes e pedidos fora do intervalo. Fontes: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`, `src/app/api/admin/approvals/route.ts`.
- [x] Recuar automaticamente para a última página válida quando filtros deixam a consola de aprovações sem resultados na página actual, evitando tabelas vazias por paginação desactualizada. Fonte: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Sinalizar quando o fallback local atinge o limite da amostra na consola de aprovações, detalhando o banner e o resumo de página com o número máximo de registos avaliados. Fontes: `src/app/api/admin/approvals/route.ts`, `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Aplicar fallback local ao filtro de estado quando a tabela Supabase usa colunas alternativas, avisando o operador e mantendo contagens limitadas coerentes. Fontes: `src/app/api/admin/approvals/route.ts`, `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Evitar flashes ao recalibrar a paginação limitada da consola de aprovações, mantendo a última página válida visível enquanto a tabela sincroniza. Fonte: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`.
- [x] Activar auto-refresh minuto a minuto na consola de aprovações e exibir indicador de última sincronização para operadores saberem quando os dados foram actualizados. Fontes: `src/app/(app)/dashboard/admin/approvals/ApprovalsClient.tsx`, `src/app/globals.css`.
- [x] Corrigir o estado "Ligação pendente" na carteira do PT para remover o prefixo duplicado e indexar a variante correcta para pesquisa, incluindo o estado cru do cliente. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Tornar os badges de alerta da carteira do PT interactivos, permitindo aplicar filtros directamente dos cartões e da tabela para acelerar a navegação por bloqueios operacionais. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Permitir alternar os filtros de alerta a partir dos próprios badges interactivos na carteira do PT, mantendo a pesquisa activa enquanto se remove rapidamente um filtro específico. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Alinhar os cartões urgentes e contadores de alertas da carteira do PT com a filtragem activa, garantindo que métricas e badges respeitam a pesquisa, o âmbito e o alerta seleccionado. Fonte: `src/app/(app)/dashboard/pt/clients/page.tsx`.
- [x] Sinalizar a última sincronização e permitir recarregamento manual do planeador semanal do PT, mantendo dados offline quando a API falha. Fonte: `src/app/(app)/dashboard/pt/plans/page.tsx`.
- [x] Evitar PATCHs redundantes no planeador semanal do PT e actualizar a data local ao mover sessões entre dias, assegurando que o UI reflicta imediatamente o novo agendamento. Fonte: `src/app/(app)/dashboard/pt/plans/page.tsx`.
- [x] Hidratar o planeador semanal do PT a partir de um snapshot offline e sincronizar a cache local após cada alteração confirmada, garantindo dados visíveis mesmo sem ligação imediata. Fonte: `src/app/(app)/dashboard/pt/plans/page.tsx`.
- [x] Documentar configuração e variáveis de ambiente actualizadas após migração para Supabase (ver `docs/supabase-environment.md`).
- 2025-10-28: Removido o grid legacy `plans.client.tsx` baseado em MUI na consola de planos administrativa, mantendo apenas a versão `.neo` activa.
- [x] Adicionar protecções de rate limiting e validações adicionais nas rotas sensíveis (limites por IP nas rotas de registo e notificações, com cabeçalhos `Retry-After` e `X-RateLimit-*`). Fontes: `src/lib/http/rateLimit.ts`, `src/app/api/register/route.ts`, `src/app/api/notifications/{list,mark-all-read,mark-read,mark-unread,unread}/route.ts`.
  - 2025-10-26: Alargámos a identificação de cliente para interpretar cabeçalhos `Forwarded`, garantindo limites justos atrás de proxies padrão.
  - Actualização: todas as respostas destas rotas incluem agora `cache-control: no-store` juntamente com os cabeçalhos de rate limiting para evitar caches intermédias inconsistentes.
- [ ] Introduzir testes automatizados (unitários/integrados) para ACL, logs e operações críticas.
  - Cobertura inicial para o módulo de rate limiting e cabeçalhos de resposta críticos (`tests/unit/rateLimit.test.ts`, `npm run test:unit`).

## Fase 3 - Funcionalidades Futuras
- [x] Finalizar módulo de facturação/pagamentos (UI `.neo` ligada à tabela `billing_invoices`, API `/api/billing/dashboard` e fallbacks determinísticos prontos para integração com gateway).
- [ ] Implementar relatórios avançados (financeiros, progresso do cliente, desempenho de PTs) — visão inicial entregue com métricas reais e ranking de treinadores; expandir para previsões e benchmarking.
- [ ] Evoluir sistema de mensagens/notificações para suporte a envio em tempo real e threads.
- [ ] Completar gestão da biblioteca de exercícios com CRUD e selector avançado.
- [ ] Introduzir um planeador de sessões/agenda com sincronização externa (Google/Apple) e insights de disponibilidade.
- [ ] Avaliar experiências mobile (PWA/app) e integração com calendários externos.
- [ ] Planear integrações futuras (wearables, pagamentos adicionais, gamificação) conforme feedback de utilizadores.
